<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wetware DeadDrop</title>
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #111;
            --text-main: #eee;
            --text-dim: #888;
            --accent-green: #0f0;
            --accent-pink: #f0f;
            --accent-cyan: #0ff;
            --accent-red: #f00;
            --accent-yellow: #ff0;
            --border: 1px solid #333;
            --font-mono: 'Courier New', Courier, monospace;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-mono);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .btn {
            background: transparent;
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 8px 12px;
            font-family: var(--font-mono);
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 0.9rem;
            touch-action: manipulation;
        }

        .btn:hover:not(:disabled) {
            background: var(--accent-green);
            color: #000;
            box-shadow: 0 0 10px var(--accent-green);
        }

        .btn:disabled {
            border-color: #444;
            color: #444;
            cursor: not-allowed;
        }

        .btn-danger {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .btn-selected {
            background: var(--accent-green);
            color: #000;
            box-shadow: 0 0 10px var(--accent-green);
        }

        .text-green { color: var(--accent-green); }
        .text-red { color: var(--accent-red); }
        .text-cyan { color: var(--accent-cyan); }
        .text-pink { color: var(--accent-pink); }
        .text-yellow { color: var(--accent-yellow); }

        header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--accent-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #000;
            z-index: 10;
        }

        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; }

        #game-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            #game-container { flex-direction: row; }
        }

        .panel {
            padding: 15px;
            overflow-y: auto;
        }

        #stats-panel {
            flex: 0 0 auto;
            background: #0a0a0a;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            border-bottom: 1px solid #333;
        }

        @media (min-width: 768px) {
            #stats-panel {
                flex: 0 0 240px;
                display: flex;
                flex-direction: column;
                border-bottom: none;
                border-right: 1px solid #333;
            }
        }

        .stat-box {
            border: 1px solid #222;
            padding: 8px;
            background: #111;
        }
        .stat-label { color: var(--text-dim); font-size: 0.65rem; text-transform: uppercase; }
        .stat-value { font-size: 1rem; font-weight: bold; }

        #main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0e0e0e;
            overflow: hidden;
        }

        #locations-bar {
            padding: 10px;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            white-space: nowrap;
            background: #000;
            -webkit-overflow-scrolling: touch;
        }

        #market-area {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 5px; color: var(--text-dim); border-bottom: 1px solid #333; font-size: 0.8rem; }
        td { padding: 12px 5px; border-bottom: 1px solid #222; font-size: 0.9rem; }

        .qty-badge {
            background: #333;
            color: var(--accent-cyan);
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.75rem;
        }

        #log-panel {
            height: 120px;
            background: #000;
            border-top: 1px solid #333;
            padding: 10px;
            font-size: 0.75rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }

        .log-entry { margin-bottom: 4px; border-left: 2px solid var(--accent-green); padding-left: 8px; }
        .log-entry.event-danger { border-left-color: var(--accent-red); }
        .log-entry.event-good { border-left-color: var(--accent-cyan); }
        .log-entry.event-warning { border-left-color: var(--accent-yellow); }
        .log-timestamp { color: var(--text-dim); font-size: 0.65rem; margin-right: 6px; }

        /* Toast notification system */
        #toast-container {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            background: #111;
            border: 2px solid var(--accent-green);
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            animation: toast-in 0.3s ease-out, toast-out 0.3s ease-in 1.7s forwards;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
            text-align: center;
            min-width: 200px;
        }
        .toast.toast-buy {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        .toast.toast-sell {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        .toast.toast-profit {
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }
        .toast.toast-loss {
            border-color: var(--accent-red);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
        }
        .toast-amount { font-size: 1.2rem; display: block; margin-top: 4px; }
        .toast-profit-info { font-size: 0.8rem; display: block; margin-top: 4px; color: var(--text-dim); }
        @keyframes toast-in {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Trade feedback flash */
        @keyframes flash-green {
            0%, 100% { background: transparent; }
            50% { background: rgba(0, 255, 0, 0.2); }
        }
        @keyframes flash-red {
            0%, 100% { background: transparent; }
            50% { background: rgba(255, 0, 0, 0.2); }
        }
        .flash-buy { animation: flash-green 0.4s ease-out; }
        .flash-sell { animation: flash-green 0.4s ease-out; }
        .flash-damage { animation: flash-red 0.4s ease-out; }

        /* Event modal styling */
        .event-text { font-size: 0.9rem; margin: 15px 0; line-height: 1.4; }

        /* Price trend indicators */
        .trend-up::after { content: ' â–²'; color: var(--accent-green); font-size: 0.7rem; }
        .trend-down::after { content: ' â–¼'; color: var(--accent-red); font-size: 0.7rem; }
        .trend-spike::after { content: ' âš¡'; color: var(--accent-yellow); font-size: 0.7rem; }
        .trend-crash::after { content: ' ðŸ’¥'; font-size: 0.7rem; }
        .trend-bubble::after { content: ' ðŸ“ˆ'; font-size: 0.7rem; }
        .trend-falling::after { content: ' ðŸ“‰'; font-size: 0.7rem; }

        /* Sector specialty indicator */
        .sector-specialty { font-size: 0.6rem; color: var(--accent-cyan); display: block; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }
        .modal {
            background: #111;
            border: 1px solid var(--accent-green);
            padding: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal.modal-danger {
            border-color: var(--accent-red);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.3);
        }
        .hidden { display: none !important; }
        input[type="number"] {
            background: #000;
            border: 1px solid var(--accent-green);
            color: #fff;
            padding: 10px;
            font-size: 1.2rem;
            width: 80%;
            margin: 15px 0;
            text-align: center;
        }

        /* Shop/Upgrade styles */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #333;
            background: #0a0a0a;
        }
        .shop-item-info { text-align: left; flex: 1; }
        .shop-item-name { font-weight: bold; color: var(--accent-cyan); }
        .shop-item-desc { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; }
        .shop-item-owned { font-size: 0.65rem; color: var(--accent-green); }
        .shop-item-price { margin-right: 10px; color: var(--accent-yellow); }

        /* Loan shark styling */
        .shark-portrait {
            font-size: 3rem;
            margin: 10px 0;
        }
        .shark-dialog {
            font-style: italic;
            color: var(--text-dim);
            margin: 15px 0;
            padding: 10px;
            border-left: 2px solid var(--accent-red);
        }
    </style>
</head>
<body>

<!-- Toast notification container -->
<div id="toast-container"></div>

<header>
    <h1>NEON<span class="text-green">TRADER</span></h1>
    <div id="header-day">Day 1/30</div>
</header>

<div id="game-container">
    <div id="stats-panel" class="panel">
        <div class="stat-box">
            <div class="stat-label">Cash</div>
            <div class="stat-value text-green" id="stat-cash">$0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Debt</div>
            <div class="stat-value text-red" id="stat-debt">$0</div>
            <button class="btn" style="padding: 4px 8px; font-size: 0.6rem; margin-top: 5px; width: 100%;" onclick="openDebtPayment()">PAY DEBT</button>
        </div>
        <div class="stat-box">
            <div class="stat-label">Hold</div>
            <div class="stat-value"><span id="stat-hold">0</span>/<span id="stat-cap">100</span></div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Health</div>
            <div class="stat-value text-pink" id="stat-health">100%</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Current Sector</div>
            <div class="stat-value text-cyan" id="stat-loc">Sector 7</div>
        </div>
        <div class="stat-box">
            <button class="btn" style="padding: 6px 10px; font-size: 0.7rem; width: 100%;" onclick="openShop()">SHOP</button>
            <div style="margin-top: 5px; display: flex; gap: 5px;">
                <button class="btn" style="padding: 4px 6px; font-size: 0.55rem; flex: 1;" onclick="saveGame()">SAVE</button>
                <button class="btn" style="padding: 4px 6px; font-size: 0.55rem; flex: 1;" onclick="loadGame()">LOAD</button>
            </div>
        </div>
    </div>

    <div id="main-panel">
        <div id="locations-bar"></div>
        <div id="market-area">
            <table>
                <thead>
                    <tr>
                        <th>ITEM</th>
                        <th>PRICE</th>
                        <th>OWNED</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="market-body"></tbody>
            </table>
        </div>
        <div id="log-panel"></div>
    </div>
</div>

<!-- Start Modal -->
<div id="modal-start" class="modal-overlay">
    <div class="modal">
        <h2 class="text-green">WETWARE DEADDROP</h2>
        <p>Buy low, sell high. Pay the shark. Survive the streets.</p>
        <p style="font-size: 0.7rem; color: var(--text-dim);">Each sector has specialties. Watch your health. Random events will test you.</p>
        <div style="margin: 20px 0;">
            <p style="font-size: 0.8rem; color: var(--accent-cyan); margin-bottom: 10px;">SELECT DIFFICULTY</p>
            <div id="difficulty-select" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;">
                <button class="btn" onclick="selectDifficulty('easy')">EASY<span class="sector-specialty">$10k / $3k</span></button>
                <button class="btn btn-selected" onclick="selectDifficulty('medium')">MEDIUM<span class="sector-specialty">$5k / $5k</span></button>
                <button class="btn" onclick="selectDifficulty('hard')">HARD<span class="sector-specialty">$3k / $5k</span></button>
            </div>
            <p style="font-size: 0.8rem; color: var(--accent-cyan); margin-bottom: 10px;">SELECT GAME LENGTH</p>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                <button class="btn" onclick="startGame(30)">30 DAYS<span class="sector-specialty">Quick</span></button>
                <button class="btn" onclick="startGame(60)">60 DAYS<span class="sector-specialty">Standard</span></button>
                <button class="btn" onclick="startGame(90)">90 DAYS<span class="sector-specialty">Extended</span></button>
                <button class="btn" onclick="startGame(180)">180 DAYS<span class="sector-specialty">Marathon</span></button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Modal -->
<div id="modal-trade" class="modal-overlay hidden">
    <div class="modal">
        <h3 id="trade-title">TRADE</h3>
        <p id="trade-info"></p>
        <p id="trade-error" class="text-red" style="font-size: 0.8rem; min-height: 1.2em;"></p>
        <input type="number" id="trade-input" pattern="\d*">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-danger" onclick="closeModal('modal-trade')">CANCEL</button>
            <button class="btn" id="trade-confirm-btn">CONFIRM</button>
        </div>
    </div>
</div>

<!-- Debt Payment Modal -->
<div id="modal-debt" class="modal-overlay hidden">
    <div class="modal">
        <h3 class="text-yellow">PAY DEBT</h3>
        <p>Current debt: <span class="text-red" id="debt-current">$0</span></p>
        <p>Your cash: <span class="text-green" id="debt-cash">$0</span></p>
        <input type="number" id="debt-input" pattern="\d*">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-danger" onclick="closeModal('modal-debt')">CANCEL</button>
            <button class="btn" onclick="confirmDebtPayment()">PAY</button>
        </div>
    </div>
</div>

<!-- Game Over Modal -->
<div id="modal-gameover" class="modal-overlay hidden">
    <div class="modal">
        <h2 id="gameover-title" class="text-red">GAME OVER</h2>
        <p id="gameover-message"></p>
        <div id="gameover-stats" style="text-align: left; margin: 15px 0; padding: 10px; background: #000; border: 1px solid #333;">
            <p>Final Cash: <span class="text-green" id="final-cash">$0</span></p>
            <p>Final Debt: <span class="text-red" id="final-debt">$0</span></p>
            <p>Net Worth: <span id="final-net">$0</span></p>
            <p>Days Survived: <span class="text-cyan" id="final-days">0</span></p>
        </div>
        <button class="btn" onclick="restartGame()">PLAY AGAIN</button>
    </div>
</div>

<!-- Random Event Modal -->
<div id="modal-event" class="modal-overlay hidden">
    <div class="modal">
        <h3 id="event-title" class="text-yellow">EVENT</h3>
        <p id="event-text" class="event-text"></p>
        <p id="event-effect" style="font-size: 0.8rem;"></p>
        <button class="btn" onclick="closeModal('modal-event')">OK</button>
    </div>
</div>

<!-- Shop Modal -->
<div id="modal-shop" class="modal-overlay hidden">
    <div class="modal">
        <h3 class="text-cyan">BLACK MARKET SHOP</h3>
        <p style="font-size: 0.7rem; color: var(--text-dim);">Your cash: <span class="text-green" id="shop-cash">$0</span></p>
        <div id="shop-items"></div>
        <button class="btn btn-danger" style="margin-top: 15px;" onclick="closeModal('modal-shop')">CLOSE</button>
    </div>
</div>

<!-- Loan Shark Modal -->
<div id="modal-shark" class="modal-overlay hidden">
    <div class="modal modal-danger">
        <div class="shark-portrait">ðŸ¦ˆ</div>
        <h3 class="text-red" id="shark-title">THE SHARK</h3>
        <p class="shark-dialog" id="shark-dialog"></p>
        <p id="shark-demand" style="font-size: 0.9rem;"></p>
        <div id="shark-buttons" style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;"></div>
    </div>
</div>

<script>
let MAX_DAYS = 30; // Default, updated on game start
let DIFFICULTY = 'medium'; // Default difficulty: easy, medium, hard

const DIFFICULTY_SETTINGS = {
    easy: { cash: 10000, debt: 3000, label: 'Easy', desc: '$10k Cash, $3k Debt' },
    medium: { cash: 5000, debt: 5000, label: 'Medium', desc: '$5k Cash, $5k Debt' },
    hard: { cash: 3000, debt: 5000, label: 'Hard', desc: '$3k Cash, $5k Debt' }
};
const ITEMS = [
    { id: 'h2o', name: 'Nano-Water', min: 5, max: 25 },
    { id: 'chips', name: 'Memory', min: 20, max: 80 },
    { id: 'stims', name: 'Neuro-Stims', min: 100, max: 400 },
    { id: 'parts', name: 'Mech-Parts', min: 500, max: 1500 },
    { id: 'cores', name: 'AI Cores', min: 2000, max: 8000 }
];

// Location specializations: each sector has cheap/expensive items
const LOCATIONS = [
    { name: "Sector 7", cheap: 'h2o', expensive: 'cores', desc: "Water district" },
    { name: "Neon Bay", cheap: 'stims', expensive: 'parts', desc: "Party zone" },
    { name: "The Stack", cheap: 'parts', expensive: 'stims', desc: "Industrial hub" },
    { name: "Void", cheap: 'cores', expensive: 'h2o', desc: "Black market" },
    { name: "High City", cheap: 'chips', expensive: 'h2o', desc: "Tech elite" }
];
const LOCS = LOCATIONS.map(l => l.name);

// Upgrades available in the shop
const UPGRADES = [
    {
        id: 'cargo',
        name: 'Cargo Expander',
        desc: '+25 carrying capacity',
        basePrice: 1000,
        priceMultiplier: 1.5, // Price increases each purchase
        maxOwned: 5,
        effect: (state) => { state.cap += 25; }
    },
    {
        id: 'medkit',
        name: 'Med-Kit',
        desc: 'Restore 35% health',
        basePrice: 500,
        priceMultiplier: 1,
        maxOwned: 99,
        effect: (state) => { state.health = Math.min(100, state.health + 35); }
    },
    {
        id: 'armor',
        name: 'Body Armor',
        desc: 'Reduce damage from events by 30%',
        basePrice: 2500,
        priceMultiplier: 1,
        maxOwned: 1,
        effect: (state) => { state.hasArmor = true; }
    },
    {
        id: 'scanner',
        name: 'Price Scanner',
        desc: 'See price trends more often',
        basePrice: 1500,
        priceMultiplier: 1,
        maxOwned: 1,
        effect: (state) => { state.hasScanner = true; }
    }
];

// Loan shark dialog options
const SHARK_DIALOGS = [
    "You've been avoiding me, runner. That's not smart.",
    "My patience is running thin. Where's my money?",
    "Did you think I'd forget about you? I never forget.",
    "Time to pay up, or things get... unpleasant.",
    "Your debt is getting out of hand. Let's fix that."
];

// Random events that can occur during travel
const EVENTS = {
    good: [
        { title: "Lucky Find!", text: "You found a stash of credits hidden in an alley.", effect: () => { const amt = Math.floor(Math.random() * 500) + 100; state.cash += amt; return `+$${amt} cash`; }},
        { title: "Market Tip", text: "A contact tips you off about a price surge.", effect: () => { const item = ITEMS[Math.floor(Math.random() * ITEMS.length)]; state.prices[item.id] = Math.floor(state.prices[item.id] * 1.5); state.priceTrends[item.id] = 'spike'; return `${item.name} prices spiked!`; }},
        { title: "Medical Supply", text: "You found some medical supplies.", effect: () => { const heal = Math.min(100 - state.health, 25); state.health += heal; return heal > 0 ? `+${heal}% health` : "Already at full health"; }},
        { title: "Debt Forgiveness", text: "An anonymous benefactor paid part of your debt.", effect: () => { const amt = Math.floor(state.debt * 0.1); state.debt -= amt; return `-$${amt} debt`; }}
    ],
    bad: [
        { title: "Mugged!", text: "A gang jumped you in a dark corridor.", effect: () => { const loss = Math.floor(state.cash * 0.15); state.cash -= loss; const dmg = state.hasArmor ? 10 : 15; state.health -= dmg; return `-$${loss} cash, -${dmg}% health`; }},
        { title: "Police Raid!", text: "Sector police confiscated some of your goods.", effect: () => { let lost = []; ITEMS.forEach(item => { if (state.inventory[item.id] > 0) { const confiscated = Math.ceil(state.inventory[item.id] * 0.2); state.inventory[item.id] -= confiscated; if (confiscated > 0) lost.push(`${confiscated} ${item.name}`); }}); return lost.length > 0 ? `Lost: ${lost.join(', ')}` : "Nothing confiscated"; }},
        { title: "Bad Deal", text: "A trader scammed you with counterfeit credits.", effect: () => { const loss = Math.floor(Math.random() * 300) + 100; state.cash = Math.max(0, state.cash - loss); return `-$${loss} cash`; }},
        { title: "Toxic Exposure", text: "You passed through a contaminated zone.", effect: () => { const dmg = state.hasArmor ? 14 : 20; state.health -= dmg; return `-${dmg}% health`; }},
        { title: "Market Crash!", text: "A major buyer pulled out of the market.", effect: () => { const item = ITEMS[Math.floor(Math.random() * ITEMS.length)]; state.prices[item.id] = Math.floor(state.prices[item.id] * 0.4); state.priceTrends[item.id] = 'crash'; return `${item.name} prices crashed!`; }}
    ],
    neutral: [
        { title: "Rumor Mill", text: "You hear whispers about price changes coming...", effect: () => { return "Stay alert for opportunities."; }},
        { title: "Sector Lockdown", text: "Temporary security increase. Nothing happened.", effect: () => { return "No effect."; }}
    ]
};

let state = {
    day: 1, cash: 5000, debt: 3000, health: 100, cap: 100,
    loc: 0, inventory: {}, prices: {}, priceTrends: {}, gameOver: false,
    // Track average purchase price for profit/loss calculation
    costBasis: {},
    // Track bubble/crash cycles: { itemId: { type: 'bubble'|'falling', duration: days_remaining, multiplier: current } }
    priceCycles: {},
    // Upgrades tracking
    upgrades: {}, // { upgradeId: count }
    hasArmor: false,
    hasScanner: false,
    // Loan shark tracking
    sharkVisits: 0,
    lastSharkDay: 0
};

function init() {
    ITEMS.forEach(i => {
        state.inventory[i.id] = 0;
        state.priceTrends[i.id] = null;
        state.costBasis[i.id] = 0;
        state.priceCycles[i.id] = null;
    });
    UPGRADES.forEach(u => {
        state.upgrades[u.id] = 0;
    });
    generatePrices();
    renderLocs();
    updateUI();
}

function selectDifficulty(diff) {
    DIFFICULTY = diff;
    // Update button selection visuals
    const buttons = document.querySelectorAll('#difficulty-select .btn');
    buttons.forEach(btn => btn.classList.remove('btn-selected'));
    event.target.classList.add('btn-selected');
}

function startGame(days = 30) {
    MAX_DAYS = days;
    // Apply difficulty settings
    const settings = DIFFICULTY_SETTINGS[DIFFICULTY];
    state.cash = settings.cash;
    state.debt = settings.debt;
    init();
    closeModal('modal-start');
    log(`New ${days}-day ${DIFFICULTY} game started. Cash: $${settings.cash.toLocaleString()}, Debt: $${settings.debt.toLocaleString()}. Good luck, runner.`, "good");
}

function generatePrices() {
    const loc = LOCATIONS[state.loc];
    ITEMS.forEach(item => {
        // Base price with random variation
        let price = Math.floor(item.min + Math.random() * (item.max - item.min));

        // Apply location specialization modifiers
        if (item.id === loc.cheap) {
            price = Math.floor(price * 0.6); // 40% discount on specialty
        } else if (item.id === loc.expensive) {
            price = Math.floor(price * 1.4); // 40% markup on rare items
        }

        // Handle bubble/crash cycles
        let cycle = state.priceCycles[item.id];
        if (cycle) {
            // Apply cycle multiplier
            price = Math.floor(price * cycle.multiplier);
            cycle.duration--;

            if (cycle.type === 'bubble') {
                // Bubble grows each day
                cycle.multiplier *= 1.15 + Math.random() * 0.1;
                state.priceTrends[item.id] = 'bubble';

                // Chance to pop the bubble
                if (cycle.duration <= 0 || Math.random() < 0.15) {
                    // Bubble pops - crash!
                    state.priceCycles[item.id] = { type: 'falling', duration: 2, multiplier: 0.5 };
                    state.priceTrends[item.id] = 'crash';
                    log(`${item.name} bubble has BURST! Prices crashing!`, 'danger');
                }
            } else if (cycle.type === 'falling') {
                // Falling prices recover slowly
                cycle.multiplier *= 0.85;
                state.priceTrends[item.id] = 'falling';

                if (cycle.duration <= 0) {
                    state.priceCycles[item.id] = null;
                    state.priceTrends[item.id] = 'down';
                }
            }
        } else {
            // No active cycle - check for new cycle or regular trends
            if (state.priceTrends[item.id] !== 'spike' && state.priceTrends[item.id] !== 'crash') {
                const roll = Math.random();
                if (roll < 0.08) {
                    // 8% chance to start a bubble
                    state.priceCycles[item.id] = { type: 'bubble', duration: 3 + Math.floor(Math.random() * 3), multiplier: 1.3 };
                    state.priceTrends[item.id] = 'bubble';
                    price = Math.floor(price * 1.3);
                    log(`${item.name} prices are surging! A bubble is forming...`, 'warning');
                } else if (roll < 0.2) {
                    state.priceTrends[item.id] = 'up';
                } else if (roll < 0.35) {
                    state.priceTrends[item.id] = 'down';
                } else {
                    state.priceTrends[item.id] = null;
                }
            }
        }

        // Floor and ceiling
        price = Math.max(item.min, Math.min(price, item.max * 3));
        state.prices[item.id] = price;
    });
}

function updateUI() {
    document.getElementById('stat-cash').innerText = '$' + state.cash.toLocaleString();
    document.getElementById('stat-debt').innerText = '$' + state.debt.toLocaleString();
    document.getElementById('stat-health').innerText = state.health + '%';
    // Update health color based on value
    const healthEl = document.getElementById('stat-health');
    healthEl.className = state.health > 50 ? 'stat-value text-pink' : (state.health > 25 ? 'stat-value text-yellow' : 'stat-value text-red');
    document.getElementById('stat-hold').innerText = Object.values(state.inventory).reduce((a,b)=>a+b,0);
    document.getElementById('stat-cap').innerText = state.cap;
    document.getElementById('stat-loc').innerText = LOCS[state.loc];
    document.getElementById('header-day').innerText = `Day ${state.day}/${MAX_DAYS}`;

    const loc = LOCATIONS[state.loc];
    const body = document.getElementById('market-body');
    body.innerHTML = '';
    ITEMS.forEach(item => {
        const row = document.createElement('tr');
        row.id = `row-${item.id}`;
        const price = state.prices[item.id];
        const owned = state.inventory[item.id];
        const trend = state.priceTrends[item.id];
        const trendClass = trend ? `trend-${trend}` : '';

        // Check if this item is cheap or expensive here
        let specialtyTag = '';
        if (item.id === loc.cheap) specialtyTag = '<span class="sector-specialty">â–¼ CHEAP HERE</span>';
        else if (item.id === loc.expensive) specialtyTag = '<span class="sector-specialty">â–² EXPENSIVE</span>';

        row.innerHTML = `
            <td>${item.name}${specialtyTag}</td>
            <td class="text-green ${trendClass}">$${price}</td>
            <td>${owned > 0 ? `<span class="qty-badge">${owned}</span>` : '-'}</td>
            <td style="text-align:right">
                <button class="btn" style="padding:4px 8px; font-size:0.7rem;" onclick="openTrade('${item.id}', 'buy')">BUY</button>
                <button class="btn" style="padding:4px 8px; font-size:0.7rem;" ${owned<=0?'disabled':''} onclick="openTrade('${item.id}', 'sell')">SELL</button>
            </td>
        `;
        body.appendChild(row);
    });
}

function renderLocs() {
    const bar = document.getElementById('locations-bar');
    bar.innerHTML = '';
    LOCATIONS.forEach((loc, i) => {
        const b = document.createElement('button');
        b.className = 'btn';
        b.innerHTML = `${loc.name}<span class="sector-specialty">${loc.desc}</span>`;
        b.style.textAlign = 'center';
        b.disabled = (i === state.loc);
        b.onclick = () => travel(i);
        bar.appendChild(b);
    });
}

function travel(idx) {
    if (state.gameOver) return;
    const prevLoc = LOCATIONS[state.loc].name;
    state.day++;
    state.loc = idx;
    const interestAdded = Math.floor(state.debt * 0.1);
    state.debt = Math.floor(state.debt * 1.1);

    // Clear simple price trends but keep cycles active
    ITEMS.forEach(i => {
        if (!state.priceCycles[i.id] && state.priceTrends[i.id] !== 'spike' && state.priceTrends[i.id] !== 'crash') {
            state.priceTrends[i.id] = null;
        }
    });

    generatePrices();
    renderLocs();
    updateUI();

    const loc = LOCATIONS[idx];
    log(`Traveled ${prevLoc} â†’ ${loc.name}. Debt interest: +$${interestAdded.toLocaleString()}`);

    // Check for random event (40% chance)
    if (Math.random() < 0.4) {
        triggerRandomEvent();
    }

    // Health-based danger: low health increases bad event chance
    if (state.health <= 25 && Math.random() < 0.3) {
        const damage = state.hasArmor ? 7 : 10;
        state.health -= damage;
        log("Your injuries are getting worse. Find medical supplies!", "danger");
        flashScreen('damage');
    }

    // Check for loan shark encounter (high debt = higher chance)
    checkLoanSharkEncounter();

    checkGameOver();
}

function triggerRandomEvent() {
    // Determine event type: 30% good, 50% bad, 20% neutral
    const roll = Math.random();
    let eventType, event;

    if (roll < 0.3) {
        eventType = 'good';
        event = EVENTS.good[Math.floor(Math.random() * EVENTS.good.length)];
    } else if (roll < 0.8) {
        eventType = 'bad';
        event = EVENTS.bad[Math.floor(Math.random() * EVENTS.bad.length)];
    } else {
        eventType = 'neutral';
        event = EVENTS.neutral[Math.floor(Math.random() * EVENTS.neutral.length)];
    }

    // Execute the event effect
    const effectResult = event.effect();

    // Show event modal
    const titleEl = document.getElementById('event-title');
    titleEl.innerText = event.title;
    titleEl.className = eventType === 'good' ? 'text-cyan' : (eventType === 'bad' ? 'text-red' : 'text-yellow');

    document.getElementById('event-text').innerText = event.text;
    document.getElementById('event-effect').innerHTML = `<span class="${eventType === 'good' ? 'text-green' : (eventType === 'bad' ? 'text-red' : 'text-yellow')}">${effectResult}</span>`;

    openModal('modal-event');

    // Log the event
    log(`[EVENT] ${event.title}: ${effectResult}`, eventType === 'bad' ? 'danger' : (eventType === 'good' ? 'good' : 'warning'));

    // Flash screen based on event type
    if (eventType === 'bad') flashScreen('damage');
    else if (eventType === 'good') flashScreen('buy');

    updateUI();
}

function flashScreen(type) {
    const container = document.getElementById('game-container');
    container.classList.add(`flash-${type}`);
    setTimeout(() => container.classList.remove(`flash-${type}`), 400);
}

function getInventoryValue() {
    let value = 0;
    ITEMS.forEach(item => {
        value += state.inventory[item.id] * state.prices[item.id];
    });
    return value;
}

function getNetWorth() {
    return state.cash + getInventoryValue() - state.debt;
}

function checkGameOver() {
    if (state.gameOver) return;

    // Lose condition: health depleted
    if (state.health <= 0) {
        endGame(false, "Your body gave out. The streets claim another soul...");
        return;
    }

    // Win condition: survived 30 days
    if (state.day > MAX_DAYS) {
        const netWorth = getNetWorth();
        if (netWorth >= 0) {
            endGame(true, "You survived 30 days and paid off your debt!");
        } else {
            endGame(false, "Time's up! You couldn't escape the debt.");
        }
        return;
    }

    // Lose condition: bankrupt (can't pay debt and no assets)
    const netWorth = getNetWorth();
    if (state.cash <= 0 && netWorth < -10000) {
        endGame(false, "You're completely bankrupt. The loan shark sends his regards...");
        return;
    }
}

function endGame(won, message) {
    state.gameOver = true;
    const netWorth = getNetWorth();

    document.getElementById('gameover-title').innerText = won ? 'YOU WIN!' : 'GAME OVER';
    document.getElementById('gameover-title').className = won ? 'text-green' : 'text-red';
    document.getElementById('gameover-message').innerText = message;
    document.getElementById('final-cash').innerText = '$' + state.cash.toLocaleString();
    document.getElementById('final-debt').innerText = '$' + state.debt.toLocaleString();
    document.getElementById('final-net').innerText = '$' + netWorth.toLocaleString();
    document.getElementById('final-net').className = netWorth >= 0 ? 'text-green' : 'text-red';
    document.getElementById('final-days').innerText = Math.min(state.day, MAX_DAYS);

    openModal('modal-gameover');
}

function restartGame() {
    state = {
        day: 1, cash: 5000, debt: 5000, health: 100, cap: 100,
        loc: 0, inventory: {}, prices: {}, priceTrends: {}, gameOver: false,
        costBasis: {}, priceCycles: {},
        upgrades: {}, hasArmor: false, hasScanner: false,
        sharkVisits: 0, lastSharkDay: 0
    };
    // Reset difficulty to default
    DIFFICULTY = 'medium';
    closeModal('modal-gameover');
    document.getElementById('log-panel').innerHTML = ''; // Clear log
    document.getElementById('toast-container').innerHTML = ''; // Clear toasts
    // Reset difficulty button selection
    const buttons = document.querySelectorAll('#difficulty-select .btn');
    buttons.forEach(btn => btn.classList.remove('btn-selected'));
    buttons[1].classList.add('btn-selected'); // Medium is index 1
    // Show start modal to let player choose game length and difficulty
    openModal('modal-start');
}

function openTrade(itemId, type) {
    if (state.gameOver) return;
    const item = ITEMS.find(i => i.id === itemId);
    const price = state.prices[itemId];

    // Clear any previous error
    document.getElementById('trade-error').innerText = '';

    document.getElementById('trade-title').innerText = (type === 'buy' ? 'BUY ' : 'SELL ') + item.name;
    document.getElementById('trade-info').innerText = `Price: $${price.toLocaleString()}`;

    let maxQty;
    if (type === 'buy') {
        const currentHold = Object.values(state.inventory).reduce((a, b) => a + b, 0);
        const spaceLeft = state.cap - currentHold;
        const affordableQty = Math.floor(state.cash / price);
        maxQty = Math.min(spaceLeft, affordableQty);
    } else {
        maxQty = state.inventory[itemId];
    }

    document.getElementById('trade-input').value = Math.max(0, maxQty);
    document.getElementById('trade-confirm-btn').onclick = () => confirmTrade(itemId, type);
    openModal('modal-trade');
}

function confirmTrade(itemId, type) {
    const qty = parseInt(document.getElementById('trade-input').value);
    const price = state.prices[itemId];
    const item = ITEMS.find(i => i.id === itemId);
    const errorEl = document.getElementById('trade-error');
    const loc = LOCATIONS[state.loc];

    if (isNaN(qty) || qty <= 0) {
        errorEl.innerText = "Enter a valid quantity";
        return;
    }

    if (type === 'buy') {
        const totalCost = qty * price;
        const currentHold = Object.values(state.inventory).reduce((a, b) => a + b, 0);
        const spaceLeft = state.cap - currentHold;

        if (qty > spaceLeft) {
            errorEl.innerText = `Not enough space! You can only carry ${spaceLeft} more.`;
            return;
        }
        if (state.cash < totalCost) {
            errorEl.innerText = `Not enough cash! You need $${totalCost.toLocaleString()}.`;
            return;
        }

        // Update cost basis (weighted average)
        const prevQty = state.inventory[itemId];
        const prevCost = state.costBasis[itemId] * prevQty;
        const newTotalCost = prevCost + totalCost;
        state.inventory[itemId] += qty;
        state.costBasis[itemId] = newTotalCost / state.inventory[itemId];

        state.cash -= totalCost;
        log(`Bought ${qty}x ${item.name} @ $${price.toLocaleString()}/ea = $${totalCost.toLocaleString()} at ${loc.name}`, 'good');
        showToast('buy', item.name, qty, totalCost);
        flashScreen('buy');
        flashRow(itemId, 'buy');
    } else {
        if (state.inventory[itemId] < qty) {
            errorEl.innerText = `You only have ${state.inventory[itemId]} to sell.`;
            return;
        }

        const totalEarned = qty * price;
        const costBasis = state.costBasis[itemId] * qty;
        const profit = totalEarned - costBasis;
        const profitPercent = costBasis > 0 ? ((profit / costBasis) * 100).toFixed(1) : 0;

        state.cash += totalEarned;
        state.inventory[itemId] -= qty;

        // Reset cost basis if sold all
        if (state.inventory[itemId] === 0) {
            state.costBasis[itemId] = 0;
        }

        const profitStr = profit >= 0 ? `+$${profit.toLocaleString()}` : `-$${Math.abs(profit).toLocaleString()}`;
        const logType = profit >= 0 ? 'good' : 'danger';
        log(`Sold ${qty}x ${item.name} @ $${price.toLocaleString()}/ea = $${totalEarned.toLocaleString()} (${profitStr}, ${profitPercent}%)`, logType);
        showToast('sell', item.name, qty, totalEarned, profit, profitPercent);
        flashScreen('sell');
        flashRow(itemId, 'sell');
    }

    closeModal('modal-trade');
    updateUI();
}

function showToast(type, itemName, qty, amount, profit = null, profitPercent = null) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');

    if (type === 'buy') {
        toast.className = 'toast toast-buy';
        toast.innerHTML = `
            <span class="text-cyan">PURCHASED</span>
            <span class="toast-amount">${qty}x ${itemName}</span>
            <span class="toast-profit-info">-$${amount.toLocaleString()}</span>
        `;
    } else {
        const isProfit = profit >= 0;
        toast.className = `toast ${isProfit ? 'toast-profit' : 'toast-loss'}`;
        const profitColor = isProfit ? 'text-green' : 'text-red';
        const profitStr = isProfit ? `+$${profit.toLocaleString()}` : `-$${Math.abs(profit).toLocaleString()}`;
        toast.innerHTML = `
            <span class="${profitColor}">SOLD</span>
            <span class="toast-amount">${qty}x ${itemName}</span>
            <span class="toast-profit-info">+$${amount.toLocaleString()}</span>
            <span class="${profitColor}" style="display:block; font-size:0.9rem; margin-top:4px;">${profitStr} (${profitPercent}%)</span>
        `;
    }

    container.appendChild(toast);

    // Remove toast after animation completes
    setTimeout(() => toast.remove(), 2000);
}

function flashRow(itemId, type) {
    const row = document.getElementById(`row-${itemId}`);
    if (row) {
        row.classList.add(`flash-${type}`);
        setTimeout(() => row.classList.remove(`flash-${type}`), 400);
    }
}

function openDebtPayment() {
    if (state.gameOver) return;
    if (state.debt <= 0) {
        log("You have no debt to pay!");
        return;
    }
    document.getElementById('debt-current').innerText = '$' + state.debt.toLocaleString();
    document.getElementById('debt-cash').innerText = '$' + state.cash.toLocaleString();
    document.getElementById('debt-input').value = Math.min(state.cash, state.debt);
    openModal('modal-debt');
}

function confirmDebtPayment() {
    const amount = parseInt(document.getElementById('debt-input').value);

    if (isNaN(amount) || amount <= 0) {
        log("Invalid payment amount.", "warning");
        closeModal('modal-debt');
        return;
    }

    if (amount > state.cash) {
        log("You don't have enough cash!", "danger");
        closeModal('modal-debt');
        return;
    }

    const payment = Math.min(amount, state.debt);
    const prevDebt = state.debt;
    state.cash -= payment;
    state.debt -= payment;

    closeModal('modal-debt');
    updateUI();

    if (state.debt <= 0) {
        log(`DEBT CLEARED! Paid final $${payment.toLocaleString()}. You're free from the shark!`, 'good');
        showDebtToast(payment, true);
    } else {
        const percentPaid = ((payment / prevDebt) * 100).toFixed(1);
        log(`Paid $${payment.toLocaleString()} (${percentPaid}%) â†’ Remaining: $${state.debt.toLocaleString()}`);
        showDebtToast(payment, false, state.debt);
    }
}

function showDebtToast(amount, cleared, remaining = 0) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.borderColor = cleared ? 'var(--accent-green)' : 'var(--accent-yellow)';
    toast.style.boxShadow = cleared ? '0 0 20px rgba(0, 255, 0, 0.5)' : '0 0 20px rgba(255, 255, 0, 0.3)';

    if (cleared) {
        toast.innerHTML = `
            <span class="text-green">DEBT CLEARED!</span>
            <span class="toast-amount">-$${amount.toLocaleString()}</span>
            <span class="text-green" style="display:block; margin-top:4px;">FREE FROM THE SHARK</span>
        `;
    } else {
        toast.innerHTML = `
            <span class="text-yellow">DEBT PAYMENT</span>
            <span class="toast-amount">-$${amount.toLocaleString()}</span>
            <span class="toast-profit-info">Remaining: $${remaining.toLocaleString()}</span>
        `;
    }

    container.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

function log(msg, type = null) {
    const p = document.getElementById('log-panel');
    const d = document.createElement('div');
    d.className = 'log-entry';
    if (type) d.classList.add(`event-${type}`);

    // Add timestamp
    const now = new Date();
    const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
    const timestamp = `<span class="log-timestamp">[Day ${state.day} ${time}]</span>`;

    d.innerHTML = `${timestamp}${msg}`;
    p.prepend(d);
}

function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

// ==================== SHOP SYSTEM ====================

function openShop() {
    if (state.gameOver) return;
    document.getElementById('shop-cash').innerText = '$' + state.cash.toLocaleString();
    renderShopItems();
    openModal('modal-shop');
}

function renderShopItems() {
    const container = document.getElementById('shop-items');
    container.innerHTML = '';

    UPGRADES.forEach(upgrade => {
        const owned = state.upgrades[upgrade.id] || 0;
        const price = Math.floor(upgrade.basePrice * Math.pow(upgrade.priceMultiplier, owned));
        const canBuy = state.cash >= price && owned < upgrade.maxOwned;
        const isSoldOut = owned >= upgrade.maxOwned;

        const div = document.createElement('div');
        div.className = 'shop-item';

        let statusText = '';
        if (upgrade.id === 'medkit') {
            statusText = '';
        } else if (isSoldOut) {
            statusText = upgrade.id === 'armor' || upgrade.id === 'scanner' ? '<span class="shop-item-owned">OWNED</span>' : '<span class="shop-item-owned">MAX</span>';
        } else if (owned > 0) {
            statusText = `<span class="shop-item-owned">Owned: ${owned}</span>`;
        }

        div.innerHTML = `
            <div class="shop-item-info">
                <div class="shop-item-name">${upgrade.name}</div>
                <div class="shop-item-desc">${upgrade.desc}</div>
                ${statusText}
            </div>
            <span class="shop-item-price">${isSoldOut ? '' : '$' + price.toLocaleString()}</span>
            <button class="btn" style="padding:4px 10px; font-size:0.7rem;"
                ${canBuy ? '' : 'disabled'}
                onclick="buyUpgrade('${upgrade.id}')">
                ${isSoldOut ? 'SOLD OUT' : 'BUY'}
            </button>
        `;
        container.appendChild(div);
    });
}

function buyUpgrade(upgradeId) {
    const upgrade = UPGRADES.find(u => u.id === upgradeId);
    const owned = state.upgrades[upgrade.id] || 0;
    const price = Math.floor(upgrade.basePrice * Math.pow(upgrade.priceMultiplier, owned));

    if (state.cash < price || owned >= upgrade.maxOwned) return;

    state.cash -= price;
    state.upgrades[upgrade.id] = owned + 1;
    upgrade.effect(state);

    log(`Purchased ${upgrade.name} for $${price.toLocaleString()}`, 'good');
    showUpgradeToast(upgrade.name, price);

    document.getElementById('shop-cash').innerText = '$' + state.cash.toLocaleString();
    renderShopItems();
    updateUI();
}

function showUpgradeToast(name, price) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast toast-buy';
    toast.innerHTML = `
        <span class="text-cyan">UPGRADE</span>
        <span class="toast-amount">${name}</span>
        <span class="toast-profit-info">-$${price.toLocaleString()}</span>
    `;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// ==================== LOAN SHARK SYSTEM ====================

function checkLoanSharkEncounter() {
    // Shark only appears if debt > $5000 and hasn't visited this day
    if (state.debt <= 5000 || state.lastSharkDay === state.day) return;

    // Chance increases with debt level
    let encounterChance = 0;
    if (state.debt > 15000) encounterChance = 0.5;
    else if (state.debt > 10000) encounterChance = 0.35;
    else if (state.debt > 5000) encounterChance = 0.2;

    if (Math.random() < encounterChance) {
        triggerSharkEncounter();
    }
}

function triggerSharkEncounter() {
    state.lastSharkDay = state.day;
    state.sharkVisits++;

    const dialog = SHARK_DIALOGS[Math.floor(Math.random() * SHARK_DIALOGS.length)];
    const demandPercent = Math.min(30 + state.sharkVisits * 5, 50); // 30-50% of debt
    const demandAmount = Math.floor(state.debt * (demandPercent / 100));

    document.getElementById('shark-dialog').innerText = `"${dialog}"`;

    let demandText = '';
    if (state.cash >= demandAmount) {
        demandText = `The shark demands <span class="text-red">$${demandAmount.toLocaleString()}</span> (${demandPercent}% of your debt).`;
    } else {
        demandText = `The shark demands <span class="text-red">$${demandAmount.toLocaleString()}</span>, but you only have <span class="text-green">$${state.cash.toLocaleString()}</span>.`;
    }
    document.getElementById('shark-demand').innerHTML = demandText;

    // Generate buttons based on what player can do
    const buttonsDiv = document.getElementById('shark-buttons');
    buttonsDiv.innerHTML = '';

    if (state.cash >= demandAmount) {
        const payBtn = document.createElement('button');
        payBtn.className = 'btn';
        payBtn.innerText = `PAY $${demandAmount.toLocaleString()}`;
        payBtn.onclick = () => sharkPay(demandAmount);
        buttonsDiv.appendChild(payBtn);
    }

    if (state.cash > 0 && state.cash < demandAmount) {
        const payAllBtn = document.createElement('button');
        payAllBtn.className = 'btn';
        payAllBtn.innerText = `PAY ALL ($${state.cash.toLocaleString()})`;
        payAllBtn.onclick = () => sharkPay(state.cash);
        buttonsDiv.appendChild(payAllBtn);
    }

    const refuseBtn = document.createElement('button');
    refuseBtn.className = 'btn btn-danger';
    refuseBtn.innerText = 'REFUSE';
    refuseBtn.onclick = () => sharkRefuse();
    buttonsDiv.appendChild(refuseBtn);

    openModal('modal-shark');
    log(`[SHARK] The loan shark found you! Debt: $${state.debt.toLocaleString()}`, 'danger');
}

function sharkPay(amount) {
    state.cash -= amount;
    state.debt -= amount;

    closeModal('modal-shark');
    updateUI();

    if (amount >= state.debt + amount) {
        log(`Paid the shark $${amount.toLocaleString()}. He seems satisfied... for now.`, 'warning');
    } else {
        log(`Paid the shark $${amount.toLocaleString()}. Remaining debt: $${state.debt.toLocaleString()}`, 'warning');
    }

    showSharkToast(amount, false);
}

function sharkRefuse() {
    closeModal('modal-shark');

    // Shark takes revenge - damage scales with visits
    const baseDamage = 15 + state.sharkVisits * 5;
    const damage = state.hasArmor ? Math.floor(baseDamage * 0.7) : baseDamage;

    state.health -= damage;
    state.debt = Math.floor(state.debt * 1.15); // 15% penalty added to debt

    log(`The shark's thugs beat you! -${damage}% health. Debt increased by 15% as "interest".`, 'danger');
    flashScreen('damage');
    showSharkToast(0, true, damage);
    updateUI();
}

function showSharkToast(amount, refused, damage = 0) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.borderColor = refused ? 'var(--accent-red)' : 'var(--accent-yellow)';
    toast.style.boxShadow = refused ? '0 0 20px rgba(255, 0, 0, 0.5)' : '0 0 20px rgba(255, 255, 0, 0.3)';

    if (refused) {
        toast.innerHTML = `
            <span class="text-red">SHARK ATTACK!</span>
            <span class="toast-amount">-${damage}% Health</span>
            <span class="toast-profit-info">+15% debt penalty</span>
        `;
    } else {
        toast.innerHTML = `
            <span class="text-yellow">PAID THE SHARK</span>
            <span class="toast-amount">-$${amount.toLocaleString()}</span>
        `;
    }

    container.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// ==================== SAVE/LOAD SYSTEM ====================

function saveGame() {
    if (state.gameOver) {
        log("Cannot save - game is over!", "warning");
        return;
    }

    const saveData = {
        version: 1,
        timestamp: Date.now(),
        state: state,
        maxDays: MAX_DAYS,
        difficulty: DIFFICULTY
    };

    try {
        localStorage.setItem('neontrader_save', JSON.stringify(saveData));
        log(`Game saved! Day ${state.day}, Cash: $${state.cash.toLocaleString()}`, 'good');
        showSaveToast('saved');
    } catch (e) {
        log("Failed to save game!", "danger");
    }
}

function loadGame() {
    try {
        const saveData = localStorage.getItem('neontrader_save');
        if (!saveData) {
            log("No save file found!", "warning");
            return;
        }

        const parsed = JSON.parse(saveData);
        if (!parsed.state) {
            log("Save file corrupted!", "danger");
            return;
        }

        // Restore state
        state = parsed.state;
        MAX_DAYS = parsed.maxDays || 30; // Restore game length (default 30 for old saves)
        DIFFICULTY = parsed.difficulty || 'medium'; // Restore difficulty (default medium for old saves)

        // Ensure new properties exist (backwards compatibility)
        if (!state.upgrades) state.upgrades = {};
        if (state.hasArmor === undefined) state.hasArmor = false;
        if (state.hasScanner === undefined) state.hasScanner = false;
        if (state.sharkVisits === undefined) state.sharkVisits = 0;
        if (state.lastSharkDay === undefined) state.lastSharkDay = 0;
        if (!state.costBasis) state.costBasis = {};
        if (!state.priceCycles) state.priceCycles = {};

        // Initialize any missing item data
        ITEMS.forEach(i => {
            if (state.inventory[i.id] === undefined) state.inventory[i.id] = 0;
            if (state.costBasis[i.id] === undefined) state.costBasis[i.id] = 0;
            if (state.priceCycles[i.id] === undefined) state.priceCycles[i.id] = null;
        });
        UPGRADES.forEach(u => {
            if (state.upgrades[u.id] === undefined) state.upgrades[u.id] = 0;
        });

        // Close start modal if open
        closeModal('modal-start');
        document.getElementById('log-panel').innerHTML = '';

        renderLocs();
        updateUI();

        const saveDate = new Date(parsed.timestamp).toLocaleString();
        log(`Game loaded! Day ${state.day}, saved ${saveDate}`, 'good');
        showSaveToast('loaded');
    } catch (e) {
        log("Failed to load game: " + e.message, "danger");
    }
}

function showSaveToast(action) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.borderColor = 'var(--accent-cyan)';
    toast.style.boxShadow = '0 0 20px rgba(0, 255, 255, 0.3)';
    toast.innerHTML = `
        <span class="text-cyan">GAME ${action.toUpperCase()}</span>
        <span class="toast-amount">Day ${state.day}</span>
    `;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// Check for existing save on load
function checkAutoLoad() {
    const saveData = localStorage.getItem('neontrader_save');
    if (saveData) {
        try {
            const parsed = JSON.parse(saveData);
            const saveDate = new Date(parsed.timestamp).toLocaleString();
            const days = parsed.maxDays || 30;
            const currentDay = parsed.state?.day || 1;
            log(`Save found: Day ${currentDay}/${days} (${saveDate}). Use LOAD to continue.`, 'warning');
        } catch (e) {}
    }
}

init();
checkAutoLoad();
</script>
</body>
</html>
